var Ci=Object.defineProperty;var sr=n=>{throw TypeError(n)};var Pi=(n,e,t)=>e in n?Ci(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var o=(n,e,t)=>Pi(n,typeof e!="symbol"?e+"":e,t),qs=(n,e,t)=>e.has(n)||sr("Cannot "+t);var i=(n,e,t)=>(qs(n,e,"read from private field"),t?t.call(n):e.get(n)),d=(n,e,t)=>e.has(n)?sr("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),l=(n,e,t,s)=>(qs(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),h=(n,e,t)=>(qs(n,e,"access private method"),t);var Ve=(n,e,t,s)=>({set _(r){l(n,e,r,t)},get _(){return i(n,e,s)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(r){if(r.ep)return;r.ep=!0;const a=t(r);fetch(r.href,a)}})();var rr=Object.prototype.hasOwnProperty;function ir(n,e,t){for(t of n.keys())if(Ge(t,e))return t}function Ge(n,e){var t,s,r;if(n===e)return!0;if(n&&e&&(t=n.constructor)===e.constructor){if(t===Date)return n.getTime()===e.getTime();if(t===RegExp)return n.toString()===e.toString();if(t===Array){if((s=n.length)===e.length)for(;s--&&Ge(n[s],e[s]););return s===-1}if(t===Set){if(n.size!==e.size)return!1;for(s of n)if(r=s,r&&typeof r=="object"&&(r=ir(e,r),!r)||!e.has(r))return!1;return!0}if(t===Map){if(n.size!==e.size)return!1;for(s of n)if(r=s[0],r&&typeof r=="object"&&(r=ir(e,r),!r)||!Ge(s[1],e.get(r)))return!1;return!0}if(t===ArrayBuffer)n=new Uint8Array(n),e=new Uint8Array(e);else if(t===DataView){if((s=n.byteLength)===e.byteLength)for(;s--&&n.getInt8(s)===e.getInt8(s););return s===-1}if(ArrayBuffer.isView(n)){if((s=n.byteLength)===e.byteLength)for(;s--&&n[s]===e[s];);return s===-1}if(!t||typeof n=="object"){s=0;for(t in n)if(rr.call(n,t)&&++s&&!rr.call(e,t)||!(t in e)||!Ge(n[t],e[t]))return!1;return Object.keys(e).length===s}}return n!==n&&e!==e}const Ni={},Oi=typeof Ni<"u"&&!1;var U,ne,B;const jt=class jt{constructor(e){d(this,U);d(this,ne,new Set);d(this,B,new Set);l(this,U,e)}static from(e){return e instanceof jt?e:new jt(e)}peek(){return i(this,U)}set(e,t){const s=i(this,U);if(l(this,U,e),t===!1||t===void 0&&s===i(this,U)||i(this,ne).size===0&&i(this,B).size===0)return;const r=i(this,ne),a=i(this,B);l(this,B,new Set),queueMicrotask(()=>{if(t===void 0&&Ge(s,i(this,U))){for(const c of a)i(this,B).add(c);return}for(const c of r)try{c(e)}catch(u){console.error("signal subscriber error",u)}for(const c of a)try{c(e)}catch(u){console.error("signal changed error",u)}})}update(e,t=!0){const s=e(i(this,U));this.set(s,t)}mutate(e,t=!0){const s=e(i(this,U));return this.set(i(this,U),t),s}subscribe(e){return i(this,ne).add(e),()=>i(this,ne).delete(e)}changed(e){return i(this,B).add(e),()=>i(this,B).delete(e)}watch(e){const t=this.subscribe(e);return queueMicrotask(()=>e(i(this,U))),t}static async race(...e){const t=[],s=await new Promise(r=>{for(const a of e)t.push(a.changed(r))});for(const r of t)r();return s}};U=new WeakMap,ne=new WeakMap,B=new WeakMap;let v=jt;var Ks,Se,y,V,G,xe,$e,ae,Ie,ut,lt,ee,$t,vr;const He=class He{constructor(e){d(this,ee);d(this,Se);d(this,y,[]);d(this,V,[]);d(this,G,[]);d(this,xe);d(this,$e,!1);d(this,ae);d(this,Ie);d(this,ut);d(this,lt);l(this,Se,e),l(this,Ie,new Promise(t=>{l(this,ae,t)})),l(this,lt,new Promise(t=>{l(this,ut,t)})),e&&h(this,ee,$t).call(this)}get(e){if(i(this,y)===void 0)return e.peek();const t=e.peek(),s=e.changed(()=>h(this,ee,$t).call(this));return i(this,V).push(s),t}set(e,t,...s){if(i(this,y)===void 0)return;e.set(t);const r=s[0],a=r===void 0?void 0:r;this.cleanup(()=>e.set(a))}spawn(e){const t=e().catch(s=>{console.error("spawn error",s)});i(this,y)!==void 0&&i(this,G).push(t)}timer(e,t){if(i(this,y)===void 0)return;let s;s=setTimeout(()=>{s=void 0,e()},t),this.cleanup(()=>s&&clearTimeout(s))}timeout(e,t){if(i(this,y)===void 0)return;const s=new He(e);let r;r=setTimeout(()=>{s.close(),r=void 0},t),i(this,y).push(()=>{r&&(clearTimeout(r),s.close())})}interval(e,t){if(i(this,y)===void 0)return;const s=setInterval(()=>{e()},t);this.cleanup(()=>clearInterval(s))}effect(e){if(i(this,y)===void 0)return;const t=new He(e);i(this,y).push(()=>t.close())}subscribe(e,t){if(i(this,y)===void 0){t(e.peek());return}this.effect(s=>{const r=s.get(e);t(r)})}event(e,t,s,r){i(this,y)!==void 0&&(e.addEventListener(t,s,r),this.cleanup(()=>e.removeEventListener(t,s,r)))}reload(){h(this,ee,$t).call(this)}cleanup(e){if(i(this,y)===void 0){e();return}i(this,y).push(e)}close(){if(i(this,y)!==void 0){i(this,ut).call(this),i(this,ae).call(this);for(const e of i(this,y))e();l(this,y,void 0);for(const e of i(this,V))e();i(this,V).length=0,i(this,G).length=0}}get closed(){return i(this,lt)}get cancel(){return i(this,Ie)}};Ks=new WeakMap,Se=new WeakMap,y=new WeakMap,V=new WeakMap,G=new WeakMap,xe=new WeakMap,$e=new WeakMap,ae=new WeakMap,Ie=new WeakMap,ut=new WeakMap,lt=new WeakMap,ee=new WeakSet,$t=function(){i(this,$e)||(l(this,$e,!0),queueMicrotask(()=>h(this,ee,vr).call(this).catch(e=>{console.error("effect error",e,i(this,xe))})))},vr=async function(){if(i(this,y)!==void 0){i(this,ae).call(this),l(this,Ie,new Promise(e=>{l(this,ae,e)}));for(const e of i(this,V))e();i(this,V).length=0;for(const e of i(this,y))e();if(i(this,y).length=0,i(this,G).length>0)try{let e;const t=new Promise(s=>{e=setTimeout(()=>{s()},5e3)});await Promise.race([Promise.all(i(this,G)),t]),e&&clearTimeout(e),i(this,G).length=0}catch(e){console.error("async effect error",e),i(this,xe)&&console.error("stack",i(this,xe))}i(this,y)!==void 0&&(l(this,$e,!1),i(this,Se)&&i(this,Se).call(this,this))}},d(He,Ks,new FinalizationRegistry(e=>{console.warn(`Signals was garbage collected without being closed:
${e}`)}));let nr=He;class Ti{constructor(){o(this,"queue",new v([]));o(this,"closed",new v(!1))}}class kr{constructor(){o(this,"state",new Ti);o(this,"closed");this.closed=new Promise(e=>{const t=this.state.closed.subscribe(s=>{s&&(e(s instanceof Error?s:void 0),t())})})}append(e){if(this.state.closed.peek())throw new Error("announced is closed");this.state.queue.mutate(t=>{t.push(e)})}close(e){this.state.closed.set(e??!0),this.state.queue.mutate(t=>{t.length=0})}async next(){for(;;){const e=this.state.queue.peek().shift();if(e)return e;const t=this.state.closed.peek();if(t instanceof Error)throw t;if(t)return;await v.race(this.state.queue,this.state.closed)}}}class Li{constructor(){o(this,"frames",new v([]));o(this,"closed",new v(!1));o(this,"total",new v(0))}}let Js=class{constructor(e){o(this,"sequence");o(this,"state",new Li);o(this,"closed");this.sequence=e,this.closed=new Promise(t=>{const s=this.state.closed.subscribe(r=>{r&&(t(r instanceof Error?r:void 0),s())})})}writeFrame(e){if(this.state.closed.peek())throw new Error("group is closed");this.state.frames.mutate(t=>{t.push(e)}),this.state.total.update(t=>t+1)}writeString(e){this.writeFrame(new TextEncoder().encode(e))}writeJson(e){this.writeString(JSON.stringify(e))}writeBool(e){this.writeFrame(new Uint8Array([e?1:0]))}async readFrame(){for(;;){const t=this.state.frames.peek().shift();if(t)return t;const s=this.state.closed.peek();if(s instanceof Error)throw s;if(s)return;await v.race(this.state.frames,this.state.closed)}}async readFrameSequence(){for(;;){const e=this.state.frames.peek(),t=e.shift();if(t)return{sequence:this.state.total.peek()-e.length-1,data:t};const s=this.state.closed.peek();if(s instanceof Error)throw s;if(s)return;await v.race(this.state.frames,this.state.closed)}}async readString(){const e=await this.readFrame();return e?new TextDecoder().decode(e):void 0}async readJson(){const e=await this.readString();return e?JSON.parse(e):void 0}async readBool(){const e=await this.readFrame();return e?e[0]===1:void 0}close(e){this.state.closed.set(e??!0)}};class Ri{constructor(){o(this,"groups",new v([]));o(this,"closed",new v(!1))}}var oe;class Bi{constructor(e){o(this,"name");o(this,"state",new Ri);d(this,oe);o(this,"closed");this.name=e,this.closed=new Promise(t=>{const s=this.state.closed.subscribe(r=>{r&&(t(r instanceof Error?r:void 0),s())})})}appendGroup(){if(this.state.closed.peek())throw new Error("track is closed");const e=new Js(i(this,oe)??0);return l(this,oe,e.sequence+1),this.state.groups.mutate(t=>{t.push(e),t.sort((s,r)=>s.sequence-r.sequence)}),e}writeGroup(e){if(this.state.closed.peek())throw new Error("track is closed");if(e.sequence<(i(this,oe)??0)){e.close();return}l(this,oe,e.sequence+1),this.state.groups.mutate(t=>{t.push(e),t.sort((s,r)=>s.sequence-r.sequence)})}writeFrame(e){const t=this.appendGroup();t.writeFrame(e),t.close()}writeString(e){const t=this.appendGroup();t.writeString(e),t.close()}writeJson(e){const t=this.appendGroup();t.writeJson(e),t.close()}writeBool(e){const t=this.appendGroup();t.writeBool(e),t.close()}async nextGroup(){for(;;){const e=this.state.groups.peek();if(e.length>0)return e.shift();const t=this.state.closed.peek();if(t instanceof Error)throw t;if(t)return;await v.race(this.state.groups,this.state.closed)}}async readFrame(){return(await this.readFrameSequence())?.data}async readFrameSequence(){for(;;){const e=this.state.groups.peek();for(;e.length>1;){const c=e[0].state.frames.peek(),u=c.shift();if(u){const f=e[0].state.total.peek()-c.length-1;return{group:e[0].sequence,frame:f,data:u}}e.shift()?.close()}if(e.length===0){const c=this.state.closed.peek();if(c instanceof Error)throw c;if(c)return;await v.race(this.state.groups,this.state.closed);continue}const t=e[0],s=t.state.frames.peek(),r=s.shift();if(r){const c=t.state.total.peek()-s.length-1;return{group:t.sequence,frame:c,data:r}}const a=this.state.closed.peek();if(a instanceof Error)throw a;if(a)return;await v.race(this.state.groups,this.state.closed,t.state.frames)}}async readString(){const e=await this.readFrame();if(e)return new TextDecoder().decode(e)}async readJson(){const e=await this.readString();if(e)return JSON.parse(e)}async readBool(){const e=await this.readFrame();if(e){if(e.byteLength!==1||!(e[0]===0||e[0]===1))throw new Error("invalid bool frame");return e[0]===1}}close(e){this.state.closed.set(e??!0);for(const t of this.state.groups.peek())t.close(e)}}oe=new WeakMap;class Di{constructor(){o(this,"requested",new v([]));o(this,"closed",new v(!1))}}class Er{constructor(){o(this,"state",new Di);o(this,"closed");this.closed=new Promise(e=>{const t=this.state.closed.subscribe(s=>{s&&(e(s instanceof Error?s:void 0),t())})})}async requested(){for(;;){const e=this.state.requested.peek().pop();if(e)return e;const t=this.state.closed.peek();if(t instanceof Error)throw t;if(t)return;await v.race(this.state.requested,this.state.closed)}}subscribe(e,t){const s=new Bi(e);if(this.state.closed.peek())throw new Error(`broadcast is closed: ${this.state.closed.peek()}`);return this.state.requested.mutate(r=>{r.push({track:s,priority:t}),r.sort((a,c)=>a.priority-c.priority)}),s}close(e){this.state.closed.set(e??!0);for(const{track:t}of this.state.requested.peek())t.close(e);this.state.requested.mutate(t=>{t.length=0})}}const ie=class ie{constructor(e){o(this,"value");if(e<0n||e>ie.MAX)throw new Error(`VarInt value out of range: ${e}`);this.value=e}static from(e){return new ie(BigInt(e))}size(){const e=this.value;if(e<2n**6n)return 1;if(e<2n**14n)return 2;if(e<2n**30n)return 4;if(e<2n**62n)return 8;throw new Error("VarInt value too large")}encode(e){const t=this.value,s=this.size();if(e.buffer.byteLength<e.byteLength+s)throw new Error("destination buffer too small");const r=new DataView(e.buffer,e.byteOffset+e.byteLength,s);if(s===1)r.setUint8(0,Number(t));else if(s===2)r.setUint16(0,16384|Number(t),!1);else if(s===4)r.setUint32(0,2<<30|Number(t),!1);else if(s===8)r.setBigUint64(0,3n<<62n|t,!1);else throw new Error("VarInt value too large");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength+s)}static decode(e){if(e.byteLength<1)throw new Error("Unexpected end of buffer");const t=new DataView(e.buffer,e.byteOffset),s=t.getUint8(0),r=s>>6;let a,c;switch(r){case 0:a=BigInt(s&63),c=1;break;case 1:if(2>e.length)throw new Error("Unexpected end of buffer");a=BigInt(t.getUint16(0,!1)&16383),c=2;break;case 2:if(4>e.length)throw new Error("Unexpected end of buffer");a=BigInt(t.getUint32(0,!1)&1073741823),c=4;break;case 3:if(8>e.length)throw new Error("Unexpected end of buffer");a=t.getBigUint64(0,!1)&0x3fffffffffffffffn,c=8;break;default:throw new Error("Invalid VarInt tag")}const u=new Uint8Array(e.buffer,e.byteOffset+c,e.byteLength-c);return[new ie(a),u]}};o(ie,"MAX",(1n<<62n)-1n),o(ie,"MAX_SIZE",8);let $=ie;const W={Bi:0,Uni:1};class fe{constructor(e){o(this,"value");this.value=e}static create(e,t,s){let r=e<<2n;return t===W.Uni&&(r|=0x02n),s&&(r|=0x01n),new fe($.from(r))}get dir(){return(this.value.value&0x02n)!==0n?W.Uni:W.Bi}get serverInitiated(){return(this.value.value&0x01n)!==0n}canRecv(e){return this.dir===W.Uni?this.serverInitiated!==e:!0}canSend(e){return this.dir===W.Uni?this.serverInitiated===e:!0}}const Sr=4,xr=5,$r=8,Fs=9,Ir=29;function ar(n){switch(n.type){case"stream":{let e=new Uint8Array(new ArrayBuffer(9+n.data.length),0,1);return e[0]=n.fin?Fs:$r,e=n.id.value.encode(e),e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength+n.data.length),e.set(n.data,e.byteLength-n.data.length),e}case"reset_stream":{let e=new Uint8Array(new ArrayBuffer(17),0,1);return e[0]=Sr,e=n.id.value.encode(e),e=n.code.encode(e),e}case"stop_sending":{let e=new Uint8Array(new ArrayBuffer(17),0,1);return e[0]=xr,e=n.id.value.encode(e),e=n.code.encode(e),e}case"connection_close":{const e=new TextEncoder().encode(n.reason);let t=new Uint8Array(new ArrayBuffer(9+e.length),0,1);return t[0]=Ir,t=n.code.encode(t),t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength+e.length),t.set(e,t.byteLength-e.length),t}}}function qi(n){if(n.length===0)throw new Error("Invalid frame: empty buffer");const e=n[0];n=n.slice(1);let t;if(e===Sr){[t,n]=$.decode(n);const s=new fe(t);return[t,n]=$.decode(n),{type:"reset_stream",id:s,code:t}}if(e===xr){[t,n]=$.decode(n);const s=new fe(t);return[t,n]=$.decode(n),{type:"stop_sending",id:s,code:t}}if(e===Ir){[t,n]=$.decode(n);const s=t,r=new TextDecoder().decode(n);return{type:"connection_close",code:s,reason:r}}if(e===$r||e===Fs)return[t,n]=$.decode(n),{type:"stream",id:new fe(t),data:n,fin:e===Fs};throw new Error(`Invalid frame type: ${e}`)}var I,H,A,ft,E,C,Qt,zt,wt,gt,Me,Ue,Xt,Mr,w,Ur,Ar,Cr,Pr,Nr,Or,Tr,se,q,It;const Kt=class Kt{constructor(e,t){d(this,w);d(this,I);d(this,H,!1);d(this,A);d(this,ft);d(this,E,new Map);d(this,C,new Map);d(this,Qt,0n);d(this,zt,0n);o(this,"ready");d(this,wt);o(this,"closed");d(this,gt);o(this,"incomingBidirectionalStreams");d(this,Me);o(this,"incomingUnidirectionalStreams");d(this,Ue);o(this,"datagrams",new Fi);var s;if(t?.requireUnreliable)throw new Error("not allowed to use WebSocket; requireUnreliable is true");t?.serverCertificateHashes&&console.warn("serverCertificateHashes is not supported; trying anyway"),e=h(s=Kt,Xt,Mr).call(s,e),l(this,I,new WebSocket(e,["webtransport"])),this.ready=new Promise(r=>{l(this,wt,r)}),this.closed=new Promise(r=>{l(this,gt,r)}),i(this,I).binaryType="arraybuffer",i(this,I).onopen=()=>i(this,wt).call(this),i(this,I).onmessage=r=>h(this,w,Ur).call(this,r),i(this,I).onerror=r=>h(this,w,Ar).call(this,r),i(this,I).onclose=r=>h(this,w,Cr).call(this,r),this.incomingBidirectionalStreams=new ReadableStream({start:r=>{l(this,Me,r)}}),this.incomingUnidirectionalStreams=new ReadableStream({start:r=>{l(this,Ue,r)}})}async createBidirectionalStream(){if(await this.ready,i(this,A))throw i(this,ft)||new Error("Connection closed");const e=fe.create(Ve(this,zt)._++,W.Bi,i(this,H)),t=new WritableStream({start:r=>{i(this,E).set(e.value.value,r)},write:async r=>{await Promise.race([h(this,w,se).call(this,{type:"stream",id:e,data:r,fin:!1}),this.closed])},abort:r=>{console.warn("abort",r),h(this,w,q).call(this,{type:"reset_stream",id:e,code:$.from(0)}),i(this,E).delete(e.value.value)},close:async()=>{await Promise.race([h(this,w,se).call(this,{type:"stream",id:e,data:new Uint8Array,fin:!0}),this.closed]),i(this,E).delete(e.value.value)}});return{readable:new ReadableStream({start:r=>{i(this,C).set(e.value.value,r)},cancel:async()=>{h(this,w,q).call(this,{type:"stop_sending",id:e,code:$.from(0)}),i(this,C).delete(e.value.value)}}),writable:t}}async createUnidirectionalStream(){if(await this.ready,i(this,A))throw i(this,A);const e=fe.create(Ve(this,Qt)._++,W.Uni,i(this,H)),t=this;return new WritableStream({start:r=>{i(t,E).set(e.value.value,r)},async write(r){var a;await Promise.race([h(a=t,w,se).call(a,{type:"stream",id:e,data:r,fin:!1}),t.closed])},abort(r){var a;console.warn("abort",r),h(a=t,w,q).call(a,{type:"reset_stream",id:e,code:$.from(0)}),i(t,E).delete(e.value.value)},async close(){var r;await Promise.race([h(r=t,w,se).call(r,{type:"stream",id:e,data:new Uint8Array,fin:!0}),t.closed]),i(t,E).delete(e.value.value)}})}close(e){if(i(this,A))return;const t=e?.closeCode??0,s=e?.reason??"";h(this,w,q).call(this,{type:"connection_close",code:$.from(t),reason:s}),setTimeout(()=>{i(this,I).close()},100),h(this,w,It).call(this,t,s)}get congestionControl(){return"default"}};I=new WeakMap,H=new WeakMap,A=new WeakMap,ft=new WeakMap,E=new WeakMap,C=new WeakMap,Qt=new WeakMap,zt=new WeakMap,wt=new WeakMap,gt=new WeakMap,Me=new WeakMap,Ue=new WeakMap,Xt=new WeakSet,Mr=function(e){const t=typeof e=="string"?new URL(e):e;let s=t.protocol;if(s==="https:")s="wss:";else if(s==="http:")s="ws:";else if(s!=="ws:"&&s!=="wss:")throw new Error(`Unsupported protocol: ${s}`);return`${s}//${t.host}${t.pathname}${t.search}`},w=new WeakSet,Ur=function(e){if(!(e.data instanceof ArrayBuffer))return;const t=new Uint8Array(e.data);try{const s=qi(t);h(this,w,Pr).call(this,s)}catch(s){console.error("Failed to decode frame:",s),this.close({closeCode:1002,reason:"Protocol violation"})}},Ar=function(e){i(this,A)||(l(this,A,new Error(`WebSocket error: ${e.type}`)),h(this,w,It).call(this,1006,"WebSocket error"))},Cr=function(e){i(this,A)||(l(this,A,new Error(`Connection closed: ${e.code} ${e.reason}`)),h(this,w,It).call(this,e.code,e.reason))},Pr=function(e){if(e.type==="stream")h(this,w,Nr).call(this,e);else if(e.type==="reset_stream")h(this,w,Or).call(this,e);else if(e.type==="stop_sending")h(this,w,Tr).call(this,e);else if(e.type==="connection_close")l(this,ft,new Error(`Connection closed: ${e.code.value}: ${e.reason}`)),i(this,I).close();else{const t=e;throw new Error(`Unknown frame type: ${t}`)}},Nr=async function(e){const t=e.id.value.value;if(!e.id.canRecv(i(this,H)))throw new Error("Invalid stream ID direction");let s=i(this,C).get(t);if(!s){if(e.id.serverInitiated===i(this,H))return;if(!e.id.canRecv(i(this,H)))throw new Error("received write-only stream");const r=new ReadableStream({start:a=>{s=a,i(this,C).set(t,a)},cancel:()=>{h(this,w,q).call(this,{type:"stop_sending",id:e.id,code:$.from(0)}),i(this,C).delete(t)}});if(e.id.dir===W.Bi){const a=new WritableStream({start:c=>{i(this,E).set(t,c)},write:async c=>{await Promise.race([h(this,w,se).call(this,{type:"stream",id:e.id,data:c,fin:!1}),this.closed])},abort:c=>{console.warn("abort",c),h(this,w,q).call(this,{type:"reset_stream",id:e.id,code:$.from(0)}),i(this,E).delete(t)},close:async()=>{await Promise.race([h(this,w,se).call(this,{type:"stream",id:e.id,data:new Uint8Array,fin:!0}),this.closed]),i(this,E).delete(t)}});i(this,Me).enqueue({readable:r,writable:a})}else i(this,Ue).enqueue(r)}e.data.byteLength>0&&s?.enqueue(e.data),e.fin&&(s?.close(),i(this,C).delete(t))},Or=function(e){const t=e.id.value.value,s=i(this,C).get(t);s&&(s.error(new Error(`RESET_STREAM: ${e.code.value}`)),i(this,C).delete(t))},Tr=function(e){const t=e.id.value.value,s=i(this,E).get(t);s&&(s.error(new Error(`STOP_SENDING: ${e.code.value}`)),i(this,E).delete(t),h(this,w,q).call(this,{type:"reset_stream",id:e.id,code:e.code}))},se=async function(e){for(;i(this,I).bufferedAmount>64*1024;)await new Promise(s=>setTimeout(s,10));const t=ar(e);i(this,I).send(t)},q=function(e){const t=ar(e);i(this,I).send(t)},It=function(e,t){i(this,gt).call(this,{closeCode:e,reason:t});try{i(this,Me).close()}catch{}try{i(this,Ue).close()}catch{}for(const s of i(this,E).values())try{s.error(i(this,A))}catch{}for(const s of i(this,C).values())try{s.error(i(this,A))}catch{}i(this,E).clear(),i(this,C).clear()},d(Kt,Xt);let Ut=Kt;class Fi{constructor(){o(this,"incomingHighWaterMark");o(this,"incomingMaxAge");o(this,"maxDatagramSize");o(this,"outgoingHighWaterMark");o(this,"outgoingMaxAge");o(this,"readable");o(this,"writable");this.incomingHighWaterMark=1024,this.incomingMaxAge=null,this.maxDatagramSize=1200,this.outgoingHighWaterMark=1024,this.outgoingMaxAge=null,this.readable=new ReadableStream({}),this.writable=new WritableStream({})}}function xt(...n){return n.join("/").replace(/\/+/g,"/").replace(/^\/+/,"").replace(/\/+$/,"")}function _i(n,e){return n===""?!0:e.startsWith(n)?e.length===n.length?!0:e[n.length]==="/":!1}function or(n,e){return _i(n,e)?n===""?e:e.length===n.length?"":e.slice(n.length+1):null}function cr(n,e){return n===""?e:e===""?n:`${n}/${e}`}function Bs(){return""}async function O(n,e){const t=e.split("/");await n.u53(t.length);for(const s of t)await n.string(s)}async function T(n){const e=[],t=await n.u53();for(let s=0;s<t;s++)e.push(await n.string());return xt(...e)}var ce;let At=(ce=class{constructor(e){o(this,"trackNamespace");this.trackNamespace=e}async encodeMessage(e){await O(e,this.trackNamespace),await e.u8(0)}static async decodeMessage(e){const t=await T(e);if(await e.u8()>0)throw new Error("unsupported announce parameters");return new ce(t)}},o(ce,"id",6),ce);const Jt=class Jt{constructor(e){o(this,"trackNamespace");this.trackNamespace=e}async encodeMessage(e){await O(e,this.trackNamespace)}static async decodeMessage(e){const t=await T(e);return new Jt(t)}};o(Jt,"id",7);let Ye=Jt;const Yt=class Yt{constructor(e,t,s){o(this,"trackNamespace");o(this,"errorCode");o(this,"reasonPhrase");this.trackNamespace=e,this.errorCode=t,this.reasonPhrase=s}async encodeMessage(e){await O(e,this.trackNamespace),await e.u62(BigInt(this.errorCode)),await e.string(this.reasonPhrase)}static async decodeMessage(e){const t=await T(e),s=Number(await e.u62()),r=await e.string();return new Yt(t,s,r)}};o(Yt,"id",8);let Ze=Yt;const Zt=class Zt{constructor(e,t=0,s=""){o(this,"trackNamespace");o(this,"errorCode");o(this,"reasonPhrase");this.trackNamespace=e,this.errorCode=t,this.reasonPhrase=s}async encodeMessage(e){await O(e,this.trackNamespace),await e.u53(this.errorCode),await e.string(this.reasonPhrase)}static async decodeMessage(e){const t=await T(e),s=await e.u53(),r=await e.string();return new Zt(t,s,r)}};o(Zt,"id",12);let et=Zt;const es=class es{constructor(e){o(this,"trackNamespace");this.trackNamespace=e}async encodeMessage(e){await O(e,this.trackNamespace)}static async decodeMessage(e){const t=await T(e);return new es(t)}};o(es,"id",9);let Re=es;const Lr=2**6-1,Rr=2**14-1,Br=2**30-1,Wi=2**31-1,Ys=Number.MAX_SAFE_INTEGER,dr=1024*1024*64;let Ct=class _s{constructor(e){o(this,"reader");o(this,"writer");this.writer=new tt(e.writable),this.reader=new Pt(e.readable)}static async accept(e){for(;;){const t=e.incomingBidirectionalStreams.getReader(),s=await t.read();return t.releaseLock(),s.done?void 0:new _s(s.value)}}static async open(e,t){return new _s(await e.createBidirectionalStream({sendOrder:t}))}close(){this.writer.close(),this.reader.stop(new Error("cancel"))}abort(e){this.writer.reset(e),this.reader.stop(e)}};var b,pt,j,m,Mt,re,F;const tr=class tr{constructor(e,t){d(this,m);d(this,b);d(this,pt);d(this,j);l(this,b,t??new Uint8Array),l(this,pt,e),l(this,j,i(this,pt)?.getReader())}async read(e){return e===0?new Uint8Array:(await h(this,m,re).call(this,e),h(this,m,F).call(this,e))}async readAll(){for(;await h(this,m,Mt).call(this););return h(this,m,F).call(this,i(this,b).byteLength)}async string(){const e=await this.u53(),t=await this.read(e);return new TextDecoder().decode(t)}async message(e){const t=await this.u53(),s=await this.read(t),r=new tr(void 0,s),a=await e(r);if(!await r.done())throw new Error("Message decoding consumed too few bytes");return a}async messageMaybe(e){if(!await this.done())return await this.message(e)}async u8(){return await h(this,m,re).call(this,1),h(this,m,F).call(this,1)[0]}async u53(){const e=await this.u62();if(e>Ys)throw new Error("value larger than 53-bits; use v62 instead");return Number(e)}async u62(){await h(this,m,re).call(this,1);const e=(i(this,b)[0]&192)>>6;if(e===0){const r=h(this,m,F).call(this,1)[0];return BigInt(r)&0x3fn}if(e===1){await h(this,m,re).call(this,2);const r=h(this,m,F).call(this,2),a=new DataView(r.buffer,r.byteOffset,r.byteLength);return BigInt(a.getUint16(0))&0x3fffn}if(e===2){await h(this,m,re).call(this,4);const r=h(this,m,F).call(this,4),a=new DataView(r.buffer,r.byteOffset,r.byteLength);return BigInt(a.getUint32(0))&0x3fffffffn}await h(this,m,re).call(this,8);const t=h(this,m,F).call(this,8);return new DataView(t.buffer,t.byteOffset,t.byteLength).getBigUint64(0)&0x3fffffffffffffffn}async done(){return i(this,b).byteLength>0?!1:!await h(this,m,Mt).call(this)}stop(e){i(this,j)?.cancel(e).catch(()=>{})}get closed(){return i(this,j)?.closed??Promise.resolve()}};b=new WeakMap,pt=new WeakMap,j=new WeakMap,m=new WeakSet,Mt=async function(){if(!i(this,j))return!1;const e=await i(this,j).read();if(e.done)return!1;if(e.value.byteLength===0)throw new Error("unexpected empty chunk");const t=new Uint8Array(e.value);if(i(this,b).byteLength===0)l(this,b,t);else{const s=new Uint8Array(i(this,b).byteLength+t.byteLength);s.set(i(this,b)),s.set(t,i(this,b).byteLength),l(this,b,s)}return!0},re=async function(e){if(e>dr)throw new Error(`read size ${e} exceeds max size ${dr}`);for(;i(this,b).byteLength<e;)if(!await h(this,m,Mt).call(this))throw new Error("unexpected end of stream")},F=function(e){const t=new Uint8Array(i(this,b).buffer,i(this,b).byteOffset,e);return l(this,b,new Uint8Array(i(this,b).buffer,i(this,b).byteOffset+e,i(this,b).byteLength-e)),t};let Pt=tr;var Q,yt,z,Ae;const ts=class ts{constructor(e){d(this,Q);d(this,yt);d(this,z);d(this,Ae);l(this,yt,e),l(this,z,new ArrayBuffer(8)),l(this,Ae,new ArrayBuffer(0)),l(this,Q,i(this,yt).getWriter())}async u8(e){await this.write(Zs(i(this,z),e))}async i32(e){if(Math.abs(e)>Wi)throw new Error(`overflow, value larger than 32-bits: ${e.toString()}`);await this.write(Vi(i(this,z),e))}async u53(e){if(e<0)throw new Error(`underflow, value is negative: ${e.toString()}`);if(e>Ys)throw new Error(`overflow, value larger than 53-bits: ${e.toString()}`);await this.write(Gi(i(this,z),e))}async u62(e){if(e<0)throw new Error(`underflow, value is negative: ${e.toString()}`);await this.write(Hi(i(this,z),e))}async write(e){await i(this,Q).write(e)}async message(e){let t=new Uint8Array(i(this,Ae),0,0);const s=new ts(new WritableStream({write(r){const a=t.byteLength+r.byteLength;if(a>t.buffer.byteLength){const c=Math.max(a,t.buffer.byteLength*2),u=new ArrayBuffer(c),f=new Uint8Array(u,0,a);f.set(t),f.set(r,t.byteLength),t=f}else t=new Uint8Array(t.buffer,0,a),t.set(r,a-r.byteLength)}}));await e(s),s.close(),await s.closed,await this.u53(t.byteLength),await this.write(t),l(this,Ae,t.buffer)}async string(e){const t=new TextEncoder().encode(e);await this.u53(t.byteLength),await this.write(t)}close(){i(this,Q).close().catch(()=>{})}get closed(){return i(this,Q).closed}reset(e){i(this,Q).abort(e).catch(()=>{})}static async open(e){const t=await e.createUnidirectionalStream();return new ts(t)}};Q=new WeakMap,yt=new WeakMap,z=new WeakMap,Ae=new WeakMap;let tt=ts;function Zs(n,e){const t=new Uint8Array(n,0,1);return t[0]=e,t}function Dr(n,e){const t=new DataView(n,0,2);return t.setUint16(0,e),new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}function Vi(n,e){const t=new DataView(n,0,4);return t.setInt32(0,e),new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}function qr(n,e){const t=new DataView(n,0,4);return t.setUint32(0,e),new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}function Gi(n,e){if(e<=Lr)return Zs(n,e);if(e<=Rr)return Dr(n,e|16384);if(e<=Br)return qr(n,e|2147483648);if(e<=Ys)return Fr(n,BigInt(e)|0xc000000000000000n);throw new Error(`overflow, value larger than 53-bits: ${e.toString()}`)}function Hi(n,e){return e<Lr?Zs(n,Number(e)):e<Rr?Dr(n,Number(e)|16384):e<=Br?qr(n,Number(e)|2147483648):Fr(n,BigInt(e)|0xc000000000000000n)}function Fr(n,e){const t=new DataView(n,0,8);return t.setBigUint64(0,e),new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}var Ce;class _r{constructor(e){d(this,Ce);l(this,Ce,e.incomingUnidirectionalStreams.getReader())}async next(){const e=await i(this,Ce).read();if(!e.done)return new Pt(e.value)}close(){i(this,Ce).cancel()}}Ce=new WeakMap;function N(n){return n instanceof Error?n:new Error(String(n))}function ji(n){throw new Error(`unreachable: ${n}`)}const Qi=new Error("request for lock canceled");var zi=function(n,e,t,s){function r(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function u(g){try{p(s.next(g))}catch(k){c(k)}}function f(g){try{p(s.throw(g))}catch(k){c(k)}}function p(g){g.done?a(g.value):r(g.value).then(u,f)}p((s=s.apply(n,e||[])).next())})};class Xi{constructor(e,t=Qi){this._value=e,this._cancelError=t,this._queue=[],this._weightedWaiters=[]}acquire(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return new Promise((s,r)=>{const a={resolve:s,reject:r,weight:e,priority:t},c=Wr(this._queue,u=>t<=u.priority);c===-1&&e<=this._value?this._dispatchItem(a):this._queue.splice(c+1,0,a)})}runExclusive(e){return zi(this,arguments,void 0,function*(t,s=1,r=0){const[a,c]=yield this.acquire(s,r);try{return yield t(a)}finally{c()}})}waitForUnlock(e=1,t=0){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);return this._couldLockImmediately(e,t)?Promise.resolve():new Promise(s=>{this._weightedWaiters[e-1]||(this._weightedWaiters[e-1]=[]),Ki(this._weightedWaiters[e-1],{resolve:s,priority:t})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(e){this._value=e,this._dispatchQueue()}release(e=1){if(e<=0)throw new Error(`invalid weight ${e}: must be positive`);this._value+=e,this._dispatchQueue()}cancel(){this._queue.forEach(e=>e.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(e){const t=this._value;this._value-=e.weight,e.resolve([t,this._newReleaser(e.weight)])}_newReleaser(e){let t=!1;return()=>{t||(t=!0,this.release(e))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let e=this._value;e>0;e--){const t=this._weightedWaiters[e-1];t&&(t.forEach(s=>s.resolve()),this._weightedWaiters[e-1]=[])}else{const e=this._queue[0].priority;for(let t=this._value;t>0;t--){const s=this._weightedWaiters[t-1];if(!s)continue;const r=s.findIndex(a=>a.priority<=e);(r===-1?s:s.splice(0,r)).forEach((a=>a.resolve()))}}}_couldLockImmediately(e,t){return(this._queue.length===0||this._queue[0].priority<t)&&e<=this._value}}function Ki(n,e){const t=Wr(n,s=>e.priority<=s.priority);n.splice(t+1,0,e)}function Wr(n,e){for(let t=n.length-1;t>=0;t--)if(e(n[t]))return t;return-1}var Ji=function(n,e,t,s){function r(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function u(g){try{p(s.next(g))}catch(k){c(k)}}function f(g){try{p(s.throw(g))}catch(k){c(k)}}function p(g){g.done?a(g.value):r(g.value).then(u,f)}p((s=s.apply(n,e||[])).next())})};class hr{constructor(e){this._semaphore=new Xi(1,e)}acquire(){return Ji(this,arguments,void 0,function*(e=0){const[,t]=yield this._semaphore.acquire(1,e);return t})}runExclusive(e,t=0){return this._semaphore.runExclusive(()=>e(),1,t)}isLocked(){return this._semaphore.isLocked()}waitForUnlock(e=0){return this._semaphore.waitForUnlock(1,e)}release(){this._semaphore.isLocked()&&this._semaphore.release()}cancel(){return this._semaphore.cancel()}}class Nt{constructor(e,t,s,r,a,c,u,f,p){o(this,"subscribeId");o(this,"trackNamespace");o(this,"trackName");o(this,"subscriberPriority");o(this,"groupOrder");o(this,"startGroup");o(this,"startObject");o(this,"endGroup");o(this,"endObject");this.subscribeId=e,this.trackNamespace=t,this.trackName=s,this.subscriberPriority=r,this.groupOrder=a,this.startGroup=c,this.startObject=u,this.endGroup=f,this.endObject=p}async encodeMessage(e){throw new Error("FETCH messages are not supported")}static async decodeMessage(e){throw new Error("FETCH messages are not supported")}}o(Nt,"id",22);class Ot{constructor(e){o(this,"subscribeId");this.subscribeId=e}async encodeMessage(e){throw new Error("FETCH_OK messages are not supported")}static async decodeMessage(e){throw new Error("FETCH_OK messages are not supported")}}o(Ot,"id",24);class Tt{constructor(e,t,s){o(this,"subscribeId");o(this,"errorCode");o(this,"reasonPhrase");this.subscribeId=e,this.errorCode=t,this.reasonPhrase=s}async encodeMessage(e){throw new Error("FETCH_ERROR messages are not supported")}static async decodeMessage(e){throw new Error("FETCH_ERROR messages are not supported")}}o(Tt,"id",25);class Ws{constructor(e){o(this,"subscribeId");this.subscribeId=e}async encodeMessage(e){throw new Error("FETCH_CANCEL messages are not supported")}static async decodeMessage(e){throw new Error("FETCH_CANCEL messages are not supported")}}o(Ws,"id",23);const ss=class ss{constructor(e){o(this,"newSessionUri");this.newSessionUri=e}async encodeMessage(e){await e.string(this.newSessionUri)}static async decodeMessage(e){const t=await e.string();return new ss(t)}};o(ss,"id",16);let st=ss;const Be=4278190087,Yi=128,me=class me{constructor(e){o(this,"role");this.role=e}async encodeMessage(e){const t=this.role==="publisher"?1:this.role==="subscriber"?2:3;await e.u53(t)}static async decodeMessage(e){const t=await e.u53();switch(t){case 1:return new me("publisher");case 2:return new me("subscriber");case 3:return new me("both");default:throw new Error(`invalid role: ${t}`)}}};o(me,"id",0);let Lt=me;const rs=class rs{constructor(e){o(this,"path");this.path=e}async encodeMessage(e){await e.string(this.path)}static async decodeMessage(e){const t=await e.string();return new rs(t)}};o(rs,"id",1);let Rt=rs;const is=class is{constructor(e){o(this,"maxSubscribeId");this.maxSubscribeId=e}async encodeMessage(e){await e.u53(this.maxSubscribeId)}static async decodeMessage(e){const t=await e.u53();return new is(t)}};o(is,"id",2);let Bt=is;const Vs={[Lt.id]:Lt,[Rt.id]:Rt,[Bt.id]:Bt},ns=class ns{constructor(...e){o(this,"parameters");this.parameters=e}async encodeMessage(e){await e.u8(1),await e.u53(Be),await e.u53(this.parameters.length);for(const t of this.parameters)await e.u53(t.constructor.id),await e.message(t.encodeMessage.bind(t))}static async decodeMessage(e){const t=await e.u53();if(t>Yi)throw new Error(`too many versions: ${t}`);const s=[];for(let c=0;c<t;c++){const u=await e.u53();s.push(u)}if(!s.some(c=>c===Be))throw new Error(`unsupported versions: ${s.join(", ")}`);const r=await e.u53(),a=[];for(let c=0;c<r;c++){const u=await e.u53(),f=Vs[u];if(!f)throw new Error(`unknown parameter: ${u}`);a.push(await f.decodeMessage(e))}return new ns(...a)}};o(ns,"id",64);let rt=ns;const as=class as{constructor(...e){o(this,"parameters");this.parameters=e}async encodeMessage(e){await e.u53(Be),await e.u53(this.parameters.length);for(const t of this.parameters)await e.u53(t.constructor.id),await e.message(t.encodeMessage.bind(t))}static async decodeMessage(e){const t=await e.u53();if(t!==Be)throw new Error(`unsupported server version: ${t.toString(16)}`);const s=await e.u53(),r=[];for(let a=0;a<s;a++){const c=await e.u53();if(!(c in Vs))throw new Error(`Unknown parameter type: ${c}`);const u=Vs[c].decodeMessage,f=await e.message(u);r.push(f)}return new as(...r)}};o(as,"id",65);let it=as;const ur=1,Gs=2;var de;let Dt=(de=class{constructor(e,t,s,r,a){o(this,"subscribeId");o(this,"trackAlias");o(this,"trackNamespace");o(this,"trackName");o(this,"subscriberPriority");this.subscribeId=e,this.trackAlias=t,this.trackNamespace=s,this.trackName=r,this.subscriberPriority=a}async encodeMessage(e){await e.u62(this.subscribeId),await e.u62(this.trackAlias),await O(e,this.trackNamespace),await e.string(this.trackName),await e.u8(this.subscriberPriority),await e.u8(Gs),await e.u8(ur),await e.u8(0)}static async decodeMessage(e){const t=await e.u62(),s=await e.u62(),r=await T(e),a=await e.string(),c=await e.u8(),u=await e.u8();if(u!==0&&u!==Gs)throw new Error(`unsupported group order: ${u}`);const f=await e.u8();if(f!==ur)throw new Error(`unsupported filter type: ${f}`);const p=await e.u8();if(p!==0)throw new Error(`SUBSCRIBE: parameters not supported: ${p}`);return new de(t,s,r,a,c)}},o(de,"id",3),de);var he;let qt=(he=class{constructor(e,t){o(this,"subscribeId");o(this,"largest");this.subscribeId=e,this.largest=t}async encodeMessage(e){await e.u62(this.subscribeId),await e.u8(0),await e.u8(Gs),this.largest?(await e.u8(1),await e.u62(this.largest[0]),await e.u62(this.largest[1])):await e.u8(0),await e.u8(0)}static async decodeMessage(e){const t=await e.u62(),s=await e.u53();if(s!==0)throw new Error(`unsupported expires: ${s}`);await e.u8();let r;await e.u8()===1&&(r=[await e.u62(),await e.u62()]);const c=await e.u8();if(c!==0)throw new Error(`SUBSCRIBE_OK: parameters not supported: ${c}`);return new he(t,r)}},o(he,"id",4),he);const os=class os{constructor(e,t,s,r){o(this,"subscribeId");o(this,"errorCode");o(this,"reasonPhrase");o(this,"trackAlias");this.subscribeId=e,this.errorCode=t,this.reasonPhrase=s,this.trackAlias=r}async encodeMessage(e){await e.u62(this.subscribeId),await e.u62(BigInt(this.errorCode)),await e.string(this.reasonPhrase),await e.u62(this.trackAlias)}static async decodeMessage(e){const t=await e.u62(),s=Number(await e.u62()),r=await e.string(),a=await e.u62();return new os(t,s,r,a)}};o(os,"id",5);let De=os;const cs=class cs{constructor(e){o(this,"subscribeId");this.subscribeId=e}async encodeMessage(e){await e.u62(this.subscribeId)}static async decodeMessage(e){const t=await e.u62();return new cs(t)}};o(cs,"id",10);let qe=cs;const ds=class ds{constructor(e,t,s,r){o(this,"subscribeId");o(this,"statusCode");o(this,"reasonPhrase");o(this,"final");this.subscribeId=e,this.statusCode=t,this.reasonPhrase=s,this.final=r}async encodeMessage(e){await e.u62(this.subscribeId),await e.u62(BigInt(this.statusCode)),await e.string(this.reasonPhrase),this.final?(await e.u8(1),await e.u62(this.final[0]),await e.u62(this.final[1])):await e.u8(0)}static async decodeMessage(e){const t=await e.u62(),s=Number(await e.u62()),r=await e.string(),a=await e.u53();let c;return a===1&&(c=[await e.u62(),await e.u62()]),new ds(t,s,r,c)}};o(ds,"id",11);let ge=ds;const hs=class hs{constructor(e){o(this,"namespace");this.namespace=e}async encodeMessage(e){await O(e,this.namespace),await e.u8(0)}static async decodeMessage(e){const t=await T(e),s=await e.u8();if(s!==0)throw new Error(`SUBSCRIBE_ANNOUNCES: parameters not supported: ${s}`);return new hs(t)}};o(hs,"id",17);let nt=hs;const us=class us{constructor(e){o(this,"namespace");this.namespace=e}async encodeMessage(e){await O(e,this.namespace)}static async decodeMessage(e){const t=await T(e);return new us(t)}};o(us,"id",18);let at=us;const ls=class ls{constructor(e,t,s){o(this,"namespace");o(this,"errorCode");o(this,"reasonPhrase");this.namespace=e,this.errorCode=t,this.reasonPhrase=s}async encodeMessage(e){await O(e,this.namespace),await e.u62(BigInt(this.errorCode)),await e.string(this.reasonPhrase)}static async decodeMessage(e){const t=await T(e),s=Number(await e.u62()),r=await e.string();return new ls(t,s,r)}};o(ls,"id",19);let ot=ls;const fs=class fs{constructor(e){o(this,"namespace");this.namespace=e}async encodeMessage(e){await O(e,this.namespace)}static async decodeMessage(e){const t=await T(e);return new fs(t)}};o(fs,"id",20);let ct=fs;const ws=class ws{constructor(e,t){o(this,"trackNamespace");o(this,"trackName");this.trackNamespace=e,this.trackName=t}async encodeMessage(e){await O(e,this.trackNamespace),await e.string(this.trackName)}static async decodeMessage(e){const t=await T(e),s=await e.string();return new ws(t,s)}};o(ws,"id",13);let dt=ws;const _=class _{constructor(e,t,s,r,a){o(this,"trackNamespace");o(this,"trackName");o(this,"statusCode");o(this,"lastGroupId");o(this,"lastObjectId");this.trackNamespace=e,this.trackName=t,this.statusCode=s,this.lastGroupId=r,this.lastObjectId=a}async encodeMessage(e){await O(e,this.trackNamespace),await e.string(this.trackName),await e.u62(BigInt(this.statusCode)),await e.u62(this.lastGroupId),await e.u62(this.lastObjectId)}static async decodeMessage(e){const t=await T(e),s=await e.string(),r=Number(await e.u62()),a=await e.u62(),c=await e.u62();return new _(t,s,r,a,c)}};o(_,"id",14),o(_,"STATUS_IN_PROGRESS",0),o(_,"STATUS_NOT_FOUND",1),o(_,"STATUS_NOT_AUTHORIZED",2),o(_,"STATUS_ENDED",3);let pe=_;const lr={[rt.id]:rt,[it.id]:it,[Dt.id]:Dt,[qt.id]:qt,[De.id]:De,[At.id]:At,[Ye.id]:Ye,[Ze.id]:Ze,[Re.id]:Re,[qe.id]:qe,[ge.id]:ge,[et.id]:et,[dt.id]:dt,[pe.id]:pe,[st.id]:st,[Nt.id]:Nt,[Ot.id]:Ot,[Tt.id]:Tt,[Ws.id]:Ws,[nt.id]:nt,[at.id]:at,[ot.id]:ot,[ct.id]:ct};var gs,ps;class Zi{constructor(e){o(this,"stream");d(this,gs,new hr);d(this,ps,new hr);this.stream=e}async write(e){console.debug("message write",e),await i(this,gs).runExclusive(async()=>{await this.stream.writer.u53(e.constructor.id),await this.stream.writer.message(e.encodeMessage.bind(e))})}async read(){return await i(this,ps).runExclusive(async()=>{const e=await this.stream.reader.u53();if(!(e in lr))throw new Error(`Unknown control message type: ${e}`);try{const t=lr[e].decodeMessage,s=await this.stream.reader.message(t);return console.debug("message read",s),s}catch(t){throw console.error("failed to decode message",e,t),t}})}}gs=new WeakMap,ps=new WeakMap;const fr=0,er=4,wr=3;var ue;let Vr=(ue=class{constructor(e,t,s,r){o(this,"subscribeId");o(this,"trackAlias");o(this,"groupId");o(this,"publisherPriority");this.subscribeId=e,this.trackAlias=t,this.groupId=s,this.publisherPriority=r}async encode(e){await e.u62(this.subscribeId),await e.u62(this.trackAlias),await e.u53(this.groupId),await e.u8(fr),await e.u8(this.publisherPriority)}static async decode(e){const t=await e.u62(),s=await e.u62(),r=await e.u53(),a=await e.u53();if(a!==fr)throw new Error(`Unsupported subgroup id: ${a}`);const c=await e.u8();return new ue(t,s,r,c)}},o(ue,"id",er),ue);class Fe{constructor(e,t){o(this,"id");o(this,"payload");this.id=e,this.payload=t}async encode(e){await e.u53(this.id),this.payload!==void 0?(await e.u53(this.payload.byteLength),this.payload.byteLength===0?await e.u8(0):await e.write(this.payload)):(await e.u8(0),await e.u8(wr))}static async decode(e){const t=await e.u53(),s=await e.u53();if(s>0){const a=await e.read(s);return new Fe(t,a)}const r=await e.u53();if(r===0||r===wr)return new Fe(t);throw new Error(`Unsupported object status: ${r}`)}}async function en(n){const e=await n.u53();if(e!==er)throw new Error(`Unsupported stream type: ${e}`)}async function tn(n){await n.u53(er)}var mt,L,Pe,te,Gr,Hr,jr,yr;let sn=(yr=class{constructor(e,t){d(this,te);d(this,mt);d(this,L);d(this,Pe,new Map);l(this,mt,e),l(this,L,t)}publish(e,t){i(this,Pe).set(e,t),h(this,te,Gr).call(this,e,t)}async handleSubscribe(e){const t=e.trackNamespace,s=i(this,Pe).get(t);if(!s){const c=new De(e.subscribeId,404,"Broadcast not found",e.trackAlias);await i(this,L).write(c);return}const r=s.subscribe(e.trackName,e.subscriberPriority),a=new qt(e.subscribeId);await i(this,L).write(a),h(this,te,Hr).call(this,e.subscribeId,e.trackAlias,r)}async handleTrackStatusRequest(e){const t=new pe(e.trackNamespace,e.trackName,pe.STATUS_NOT_FOUND,0n,0n);await i(this,L).write(t)}async handleUnsubscribe(e){}async handleAnnounceOk(e){}async handleAnnounceError(e){}async handleAnnounceCancel(e){}async handleSubscribeAnnounces(e){}async handleUnsubscribeAnnounces(e){}},mt=new WeakMap,L=new WeakMap,Pe=new WeakMap,te=new WeakSet,Gr=async function(e,t){try{const s=new At(e);await i(this,L).write(s),await t.closed;const r=new Re(e);await i(this,L).write(r)}catch(s){const r=N(s);console.warn(`announce failed: broadcast=${e} error=${r.message}`)}finally{t.close(),i(this,Pe).delete(e)}},Hr=async function(e,t,s){try{for(;;){const a=await s.nextGroup();if(!a)break;h(this,te,jr).call(this,e,t,a)}const r=new ge(e,200,"OK");await i(this,L).write(r)}catch(r){const a=N(r),c=new ge(e,500,a.message);await i(this,L).write(c)}finally{s.close()}},jr=async function(e,t,s){try{const r=await tt.open(i(this,mt));await tn(r),await new Vr(e,t,s.sequence,0).encode(r);try{let c=0;for(;;){const f=await Promise.race([s.readFrame(),r.closed]);if(!f)break;await new Fe(c,f).encode(r),c++}await new Fe(c).encode(r),r.close()}catch(c){r.reset(N(c))}}finally{s.close()}},yr);var Ne,Oe,ys,X,ms,Qr,mr;let rn=(mr=class{constructor(e){d(this,ms);d(this,Ne);d(this,Oe,new Map);d(this,ys,0n);d(this,X,new Map);l(this,Ne,e)}announced(e=Bs()){return new kr}consume(e){const t=new Er;return(async()=>{for(;;){const s=await t.requested();if(!s)break;h(this,ms,Qr).call(this,e,s)}})(),t}async handleSubscribeOk(e){const t=i(this,X).get(e.subscribeId);t&&t.resolve(e)}async handleSubscribeError(e){const t=i(this,X).get(e.subscribeId);t&&t.reject(new Error(`SUBSCRIBE_ERROR: code=${e.errorCode} reason=${e.reasonPhrase}`))}async handleGroup(e,t){const s=new Js(e.groupId);try{const r=i(this,Oe).get(e.trackAlias);if(!r)throw new Error(`unknown track: alias=${e.trackAlias}`);for(r.writeGroup(s);await Promise.race([t.done(),s.closed,r.closed])===!1;){const c=await Fe.decode(t);if(c.payload===void 0)break;s.writeFrame(c.payload)}s.close()}catch(r){const a=N(r);s.close(a),t.stop(a)}}async handleSubscribeDone(e){const t=i(this,X).get(e.subscribeId);t&&t.reject(new Error(`SUBSCRIBE_DONE: code=${e.statusCode} reason=${e.reasonPhrase}`))}async handleAnnounce(e){}async handleUnannounce(e){}async handleSubscribeAnnouncesOk(e){}async handleSubscribeAnnouncesError(e){}async handleTrackStatus(e){}},Ne=new WeakMap,Oe=new WeakMap,ys=new WeakMap,X=new WeakMap,ms=new WeakSet,Qr=async function(e,t){const s=Ve(this,ys)._++;i(this,Oe).set(s,t.track);const r=new Dt(s,s,e,t.track.name,t.priority),a=new Promise((c,u)=>{i(this,X).set(s,{resolve:c,reject:u})});await i(this,Ne).write(r);try{await a,await t.track.closed;const c=new qe(s);await i(this,Ne).write(c)}catch(c){const u=N(c);t.track.close(u)}finally{i(this,Oe).delete(s),i(this,X).delete(s)}},mr);var K,le,P,x,S,zr,Xr,Kr,Jr,Yr,Zr,ei,br;let nn=(br=class{constructor(e,t,s){d(this,S);o(this,"url");d(this,K);d(this,le);d(this,P);d(this,x);this.url=e,l(this,K,t),l(this,le,new Zi(s)),l(this,P,new sn(i(this,K),i(this,le))),l(this,x,new rn(i(this,le))),h(this,S,zr).call(this)}close(){try{i(this,K).close()}catch{}}publish(e,t){i(this,P).publish(e,t)}announced(e=Bs()){return i(this,x).announced(e)}consume(e){return i(this,x).consume(e)}get closed(){return i(this,K).closed.then(()=>{})}},K=new WeakMap,le=new WeakMap,P=new WeakMap,x=new WeakMap,S=new WeakSet,zr=async function(){const e=h(this,S,Xr).call(this),t=h(this,S,Zr).call(this);try{await Promise.all([e,t])}catch(s){console.error("fatal error running connection",s)}finally{this.close()}},Xr=async function(){for(;;)try{const e=await i(this,le).read();e instanceof Dt?await i(this,P).handleSubscribe(e):e instanceof qe?await i(this,P).handleUnsubscribe(e):e instanceof dt?await i(this,P).handleTrackStatusRequest(e):e instanceof Ye?await i(this,P).handleAnnounceOk(e):e instanceof Ze?await i(this,P).handleAnnounceError(e):e instanceof et?await i(this,P).handleAnnounceCancel(e):e instanceof At?await i(this,x).handleAnnounce(e):e instanceof Re?await i(this,x).handleUnannounce(e):e instanceof qt?await i(this,x).handleSubscribeOk(e):e instanceof De?await i(this,x).handleSubscribeError(e):e instanceof ge?await i(this,x).handleSubscribeDone(e):e instanceof pe?await i(this,x).handleTrackStatus(e):e instanceof st?await h(this,S,Kr).call(this,e):e instanceof rt?await h(this,S,Jr).call(this,e):e instanceof it?await h(this,S,Yr).call(this,e):e instanceof nt?await i(this,P).handleSubscribeAnnounces(e):e instanceof at?await i(this,x).handleSubscribeAnnouncesOk(e):e instanceof ot?await i(this,x).handleSubscribeAnnouncesError(e):e instanceof ct?await i(this,P).handleUnsubscribeAnnounces(e):e instanceof Nt||e instanceof Ot||e instanceof Tt||ji(e)}catch(e){console.error("error processing control message",e);break}console.warn("control stream closed")},Kr=async function(e){console.warn(`MOQLITE_INCOMPATIBLE: Received GOAWAY with redirect URI: ${e.newSessionUri}`),this.close()},Jr=async function(e){console.error("Unexpected CLIENT_SETUP message received after connection established"),this.close()},Yr=async function(e){console.error("Unexpected SERVER_SETUP message received after connection established"),this.close()},Zr=async function(){const e=new _r(i(this,K));for(;;){const t=await e.next();if(!t)break;h(this,S,ei).call(this,t).then(()=>{t.stop(new Error("cancel"))}).catch(s=>{t.stop(s)})}},ei=async function(e){try{await en(e);const t=await Vr.decode(e);await i(this,x).handleGroup(t,e)}catch(t){console.error("error processing object stream",t)}},br);var bs,ti,bt,Hs;const be=class be{constructor(e,t){d(this,bs);o(this,"suffix");o(this,"active");this.suffix=e,this.active=t}async encode(e){return e.message(h(this,bs,ti).bind(this))}static async decode(e){return e.message(h(be,bt,Hs))}static async decodeMaybe(e){return e.messageMaybe(h(be,bt,Hs))}};bs=new WeakSet,ti=async function(e){await e.u8(this.active?1:0),await e.string(this.suffix)},bt=new WeakSet,Hs=async function(e){const t=await e.u8()===1,s=xt(await e.string());return new be(s,t)},d(be,bt);let ht=be;var vs,si,ks,ri;const je=class je{constructor(e){d(this,vs);o(this,"prefix");this.prefix=e}async encode(e){return e.message(h(this,vs,si).bind(this))}static async decode(e){return e.message(h(je,ks,ri))}};vs=new WeakSet,si=async function(e){await e.string(this.prefix)},ks=new WeakSet,ri=async function(e){const t=xt(await e.string());return new je(t)},d(je,ks);let Ft=je;var Es,ii,Ss,ni;const Qe=class Qe{constructor(e){d(this,Es);o(this,"suffixes");this.suffixes=e}async encode(e){return e.message(h(this,Es,ii).bind(this))}static async decode(e){return e.message(h(Qe,Ss,ni))}};Es=new WeakSet,ii=async function(e){await e.u53(this.suffixes.length);for(const t of this.suffixes)await e.string(t)},Ss=new WeakSet,ni=async function(e){const t=await e.u53(),s=[];for(let r=0;r<t;r++)s.push(xt(await e.string()));return new Qe(s)},d(Qe,Ss);let _t=Qe;var xs,ai,vt,js;const ve=class ve{constructor(e,t){d(this,xs);o(this,"subscribe");o(this,"sequence");this.subscribe=e,this.sequence=t}async encode(e){return e.message(h(this,xs,ai).bind(this))}static async decode(e){return e.message(h(ve,vt,js))}static async decodeMaybe(e){return e.messageMaybe(h(ve,vt,js))}};xs=new WeakSet,ai=async function(e){await e.u62(this.subscribe),await e.u53(this.sequence)},vt=new WeakSet,js=async function(e){return new ve(await e.u62(),await e.u53())},d(ve,vt);let Wt=ve;var $s,oi,Is,ci;const ke=class ke{constructor(e){d(this,$s);o(this,"priority");this.priority=e}async encode(e){return e.message(h(this,$s,oi).bind(this))}static async decode(e){return e.message(h(ke,Is,ci))}static async decodeMaybe(e){if(!await e.done())return ke.decode(e)}};$s=new WeakSet,oi=async function(e){await e.u8(this.priority)},Is=new WeakSet,ci=async function(e){const t=await e.u8();return new ke(t)},d(ke,Is);let Vt=ke;var Ms,di,Us,hi;const ze=class ze{constructor(e,t,s,r){d(this,Ms);o(this,"id");o(this,"broadcast");o(this,"track");o(this,"priority");this.id=e,this.broadcast=t,this.track=s,this.priority=r}async encode(e){return e.message(h(this,Ms,di).bind(this))}static async decode(e){return e.message(h(ze,Us,hi))}};Ms=new WeakSet,di=async function(e){await e.u62(this.id),await e.string(this.broadcast),await e.string(this.track),await e.u8(this.priority)},Us=new WeakSet,hi=async function(e){const t=await e.u62(),s=xt(await e.string()),r=await e.string(),a=await e.u8();return new ze(t,s,r,a)},d(ze,Us);let Gt=ze;var As,ui,Cs,li;const Xe=class Xe{constructor(e){d(this,As);o(this,"priority");this.priority=e}async encode(e){return e.message(h(this,As,ui).bind(this))}static async decode(e){return e.message(h(Xe,Cs,li))}};As=new WeakSet,ui=async function(e){await e.u8(this.priority)},Cs=new WeakSet,li=async function(e){const t=await e.u8();return new Xe(t)},d(Xe,Cs);let Ht=Xe;var kt,D,_e,fi,wi;class an{constructor(e){d(this,_e);d(this,kt);d(this,D,new v(new Map));l(this,kt,e)}publish(e,t){i(this,D).mutate(s=>{if(!s)throw new Error("closed");s.set(e,t)}),t.closed.finally(()=>{i(this,D).mutate(s=>{s?.delete(e)})})}async runAnnounce(e,t){console.debug(`announce: prefix=${e.prefix}`);let s=new Set;const r=i(this,D).peek();if(!r)return;for(const c of r.keys()){const u=or(e.prefix,c);u!==null&&(console.debug(`announce: broadcast=${c} active=true`),s.add(u))}for(await new _t(s.values().toArray()).encode(t.writer);;){let c;const u=new Promise(g=>{c=i(this,D).changed(g)}),f=await Promise.race([u,t.reader.closed]);if(c(),!f)break;const p=new Set;for(const g of f.keys()){const k=or(e.prefix,g);k!==null&&p.add(k)}for(const g of p.difference(s))console.debug(`announce: broadcast=${g} active=true`),await new ht(g,!0).encode(t.writer);for(const g of s.difference(p))console.debug(`announce: broadcast=${g} active=false`),await new ht(g,!1).encode(t.writer);s=p}}async runSubscribe(e,t){const s=i(this,D).peek()?.get(e.broadcast);if(!s){console.debug(`publish unknown: broadcast=${e.broadcast}`),t.writer.reset(new Error("not found"));return}const r=s.subscribe(e.track,e.priority);try{await new Ht(e.priority).encode(t.writer),console.debug(`publish ok: broadcast=${e.broadcast} track=${r.name}`);const c=h(this,_e,fi).call(this,e.id,e.broadcast,r,t.writer);for(;;){const u=Vt.decodeMaybe(t.reader),f=await Promise.any([c,u]);if(!f)break;f instanceof Vt&&console.warn("subscribe update not supported",f)}console.debug(`publish done: broadcast=${e.broadcast} track=${r.name}`),t.close(),r.close()}catch(a){const c=N(a);console.warn(`publish error: broadcast=${e.broadcast} track=${r.name} error=${c.message}`),r.close(c),t.abort(c)}}close(){i(this,D).update(e=>{for(const t of e?.values()??[])t.close()})}}kt=new WeakMap,D=new WeakMap,_e=new WeakSet,fi=async function(e,t,s,r){try{for(;;){const a=s.nextGroup(),c=await Promise.race([a,r.closed]);if(!c){a.then(u=>u?.close()).catch(()=>{});break}h(this,_e,wi).call(this,e,c)}console.debug(`publish close: broadcast=${t} track=${s.name}`),s.close(),r.close()}catch(a){const c=N(a);console.warn(`publish error: broadcast=${t} track=${s.name} error=${c.message}`),s.close(c),r.reset(c)}},wi=async function(e,t){const s=new Wt(e,t.sequence);try{const r=await tt.open(i(this,kt));await r.u8(0),await s.encode(r);try{for(;;){const a=await Promise.race([t.readFrame(),r.closed]);if(!a)break;await r.u53(a.byteLength),await r.write(a)}r.close(),t.close()}catch(a){const c=N(a);r.reset(c),t.close(c)}}catch(r){const a=N(r);t.close(a)}};const on={LITE_01:4279086337},gr=on.LITE_01;class ye{constructor(){o(this,"entries");this.entries=new Map}set(e,t){this.entries.set(e,t)}get(e){return this.entries.get(e)}remove(e){const t=this.entries.get(e);return this.entries.delete(e),t}async encode(e){await e.u53(this.entries.size);for(const[t,s]of this.entries)await e.u62(t),await e.u53(s.length),await e.write(s)}static async decode(e){const t=await e.u53(),s=new ye;for(let r=0;r<t;r++){const a=await e.u62(),c=await e.u53(),u=await e.read(c);if(s.entries.has(a))throw new Error(`duplicate parameter id: ${a.toString()}`);s.entries.set(a,u)}return s}}var Ps,gi,Ns,pi;const Ke=class Ke{constructor(e,t=new ye){d(this,Ps);o(this,"versions");o(this,"extensions");this.versions=e,this.extensions=t}async encode(e){return e.message(h(this,Ps,gi).bind(this))}static async decode(e){return e.message(h(Ke,Ns,pi))}};Ps=new WeakSet,gi=async function(e){await e.u53(this.versions.length);for(const t of this.versions)await e.u53(t);await this.extensions.encode(e)},Ns=new WeakSet,pi=async function(e){const t=[],s=await e.u53();for(let a=0;a<s;a++)t.push(await e.u53());const r=await ye.decode(e);return new Ke(t,r)},d(Ke,Ns);let Qs=Ke;var Os,yi,Ts,mi;const Je=class Je{constructor(e,t=new ye){d(this,Os);o(this,"version");o(this,"extensions");this.version=e,this.extensions=t}async encode(e){return e.message(h(this,Os,yi).bind(this))}static async decode(e){return e.message(h(Je,Ts,mi))}};Os=new WeakSet,yi=async function(e){await e.u53(this.version),await this.extensions.encode(e)},Ts=new WeakSet,mi=async function(e){const t=await e.u53(),s=await ye.decode(e);return new Je(t,s)},d(Je,Ts);let zs=Je;var Ls,bi,Rs,vi;const Ee=class Ee{constructor(e){d(this,Ls);o(this,"bitrate");this.bitrate=e}async encode(e){return e.message(h(this,Ls,bi).bind(this))}static async decode(e){return e.message(h(Ee,Rs,vi))}static async decodeMaybe(e){if(!await e.done())return await Ee.decode(e)}};Ls=new WeakSet,bi=async function(e){await e.u53(this.bitrate)},Rs=new WeakSet,vi=async function(e){const t=await e.u53();return new Ee(t)},d(Ee,Rs);let Xs=Ee;const we={Session:0,Announce:1,Subscribe:2,ClientCompat:64,ServerCompat:65};var Te,J,Et,We,ki,Ei;class cn{constructor(e){d(this,We);d(this,Te);d(this,J,new Map);d(this,Et,0n);l(this,Te,e)}announced(e=Bs()){const t=new kr;return h(this,We,ki).call(this,t,e),t}consume(e){const t=new Er;return(async()=>{for(;;){const s=await t.requested();if(!s)break;h(this,We,Ei).call(this,e,s)}})(),t}async runGroup(e,t){const s=i(this,J).get(e.subscribe);if(!s){if(e.subscribe>=i(this,Et))throw new Error(`unknown subscription: id=${e.subscribe}`);return}const r=new Js(e.sequence);s.writeGroup(r);try{for(;await Promise.race([t.done(),s.closed,r.closed])===!1;){const c=await t.u53(),u=await t.read(c);if(!u)break;r.writeFrame(u)}r.close(),t.stop(new Error("cancel"))}catch(a){const c=N(a);r.close(c),t.stop(c)}}close(){for(const e of i(this,J).values())e.close();i(this,J).clear()}}Te=new WeakMap,J=new WeakMap,Et=new WeakMap,We=new WeakSet,ki=async function(e,t){console.debug(`announced: prefix=${t}`);const s=new Ft(t);try{const r=await Ct.open(i(this,Te));await r.writer.u8(we.Announce),await s.encode(r.writer);const a=await _t.decode(r.reader);for(const c of a.suffixes){const u=cr(t,c);console.debug(`announced: broadcast=${u} active=true`),e.append({path:u,active:!0})}for(;;){const c=await Promise.race([ht.decodeMaybe(r.reader),e.closed]);if(!c)break;if(c instanceof Error)throw c;const u=cr(t,c.suffix);console.debug(`announced: broadcast=${u} active=${c.active}`),e.append({path:u,active:c.active})}e.close()}catch(r){e.close(N(r))}},Ei=async function(e,t){const s=Ve(this,Et)._++;i(this,J).set(s,t.track),console.debug(`subscribe start: id=${s} broadcast=${e} track=${t.track.name}`);const r=new Gt(s,e,t.track.name,t.priority),a=await Ct.open(i(this,Te));await a.writer.u8(we.Subscribe),await r.encode(a.writer);try{await Ht.decode(a.reader),console.debug(`subscribe ok: id=${s} broadcast=${e} track=${t.track.name}`),await Promise.race([a.reader.closed,t.track.closed]),t.track.close(),a.close(),console.debug(`subscribe close: id=${s} broadcast=${e} track=${t.track.name}`)}catch(c){const u=N(c);t.track.close(u),console.warn(`subscribe error: id=${s} broadcast=${e} track=${t.track.name} error=${u.message}`),a.abort(u)}finally{i(this,J).delete(s)}};var R,St,Y,Z,Le,M,Si,xi,$i,Ii,Mi,Ui;class dn{constructor(e,t,s){d(this,M);o(this,"url");d(this,R);d(this,St);d(this,Y);d(this,Z);d(this,Le,!1);this.url=e,l(this,R,t),l(this,St,s),l(this,Y,new an(i(this,R))),l(this,Z,new cn(i(this,R))),h(this,M,Si).call(this)}close(){if(!i(this,Le)){l(this,Le,!0),i(this,Y).close(),i(this,Z).close();try{i(this,R).close()}catch{}}}publish(e,t){i(this,Y).publish(e,t)}announced(e=Bs()){return i(this,Z).announced(e)}consume(e){return i(this,Z).consume(e)}get closed(){return i(this,R).closed.then(()=>{})}}R=new WeakMap,St=new WeakMap,Y=new WeakMap,Z=new WeakMap,Le=new WeakMap,M=new WeakSet,Si=async function(){const e=h(this,M,xi).call(this),t=h(this,M,$i).call(this),s=h(this,M,Mi).call(this);try{await Promise.all([e,t,s])}catch(r){i(this,Le)||console.error("fatal error running connection",r)}finally{this.close()}},xi=async function(){try{for(;await Xs.decodeMaybe(i(this,St).reader););}finally{console.warn("session stream closed")}},$i=async function(){for(;;){const e=await Ct.accept(i(this,R));if(!e)break;h(this,M,Ii).call(this,e).catch(t=>{e.writer.reset(t)}).finally(()=>{e.writer.close()})}},Ii=async function(e){const t=await e.reader.u8();if(t===we.Session)throw new Error("duplicate session stream");if(t===we.Announce){const s=await Ft.decode(e.reader);await i(this,Y).runAnnounce(s,e);return}else if(t===we.Subscribe){const s=await Gt.decode(e.reader);await i(this,Y).runSubscribe(s,e);return}else throw new Error(`unknown stream type: ${t.toString()}`)},Mi=async function(){const e=new _r(i(this,R));for(;;){const t=await e.next();if(!t)break;h(this,M,Ui).call(this,t).then(()=>{t.stop(new Error("cancel"))}).catch(s=>{t.stop(s)})}},Ui=async function(e){const t=await e.u8();if(t===0){const s=await Wt.decode(e);await i(this,Z).runGroup(s,e)}else throw new Error(`unknown stream type: ${t.toString()}`)};function hn(n){if(n=n.startsWith("0x")?n.slice(2):n,n.length%2)throw new Error("invalid hex string length");const e=n.match(/.{2}/g);if(!e)throw new Error("invalid hex string format");return new Uint8Array(e.map(t=>parseInt(t,16)))}const pr=new Set;async function un(n,e){let t;const s=new Promise(Ai=>{t=Ai}),r=globalThis.WebTransport?ln(n,s,e?.webtransport):void 0,a=!r||pr.has(n.toString())?0:e?.websocket?.delay??200,c=e?.websocket?.enabled!==!1?fn(e?.websocket?.url??n,a,s):void 0;if(!c&&!r)throw new Error("no transport available; WebTransport not supported and WebSocket is disabled");const u=await Promise.any(r?c?[c,r]:[r]:[c]);if(t&&t(),!u)throw new Error("no transport available");u instanceof Ut&&(console.warn(n.toString(),"using WebSocket fallback; the user experience may be degraded"),pr.add(n.toString()));const f=new ye;f.set(0x0n,new Uint8Array([3]));const p=new Qs([gr,Be],f),g=await Ct.open(u);await g.writer.u53(we.ClientCompat),await p.encode(g.writer);const k=await g.reader.u53();if(k!==we.ServerCompat)throw new Error(`unsupported server message type: ${k.toString()}`);const Ds=await zs.decode(g.reader);if(Ds.version===gr)return console.debug(n.toString(),"moq-lite session established"),new dn(n,u,g);if(Ds.version===Be)return console.debug(n.toString(),"moq-ietf session established"),new nn(n,u,g);throw new Error(`unsupported server version: ${Ds.version.toString()}`)}async function ln(n,e,t){let s=n;const r={allowPooling:!1,congestionControl:"low-latency",...t};if(n.protocol==="http:"){const u=new URL(n);u.pathname="/certificate.sha256",u.search="",console.warn(u.toString(),"performing an insecure fingerprint fetch; use https:// in production");const f=await Promise.race([fetch(u),e]);if(!f)return;const p=await Promise.race([f.text(),e]);if(p===void 0)return;r.serverCertificateHashes=(r.serverCertificateHashes||[]).concat([{algorithm:"sha-256",value:hn(p)}]),s=new URL(n),s.protocol="https:"}const a=new WebTransport(s,r);if(!await Promise.race([a.ready.then(()=>!0),e])){a.close();return}return a}async function fn(n,e,t){const s=new Promise(u=>setTimeout(u,e));if(!await Promise.race([t,s.then(()=>!0)]))return;e&&console.debug(n.toString(),`no WebTransport after ${e}ms, attempting WebSocket fallback`);const a=new Ut(n);if(!await Promise.race([a.ready.then(()=>!0),t])){a.close();return}return a}console.log("🎥 MOQ Video Client - VERSION 3.20 - FIXED avcC DETECTION!");class wn{constructor(e){this.connection=null,this.broadcast=null,this.videoTrack=null,this.decoder=null,this.statsInterval=null,this.avcConfig=null,this.canvas=e,this.ctx=e.getContext("2d"),this.stats={startTime:0,framesReceived:0,framesDecoded:0,bytesReceived:0,fps:0},this.initializeDecoder(),this.log("✅ MOQ Video Client initialized")}initializeDecoder(){this.log("🔧 Initializing WebCodecs H.264 decoder..."),this.decoder=new VideoDecoder({output:e=>{this.renderFrame(e),this.stats.framesDecoded++,this.log(`✅ Decoded frame: ${e.codedWidth}x${e.codedHeight}, timestamp=${e.timestamp}`),e.close()},error:e=>{console.error("❌ Decoder error:",e),this.log(`❌ DECODER CRASH: ${e.name}: ${e.message}`),this.log(`❌ Decoder state at crash: ${this.decoder?.state||"unknown"}`),"code"in e&&this.log(`❌ Error code: ${e.code}`),this.log(`❌ This crash happened after ${this.stats.framesDecoded} successfully decoded frames`)}}),this.log("✅ WebCodecs decoder initialized")}renderFrame(e){const t=e.displayWidth,s=e.displayHeight;(this.canvas.width!==t||this.canvas.height!==s)&&(this.canvas.width=t,this.canvas.height=s,this.log(`📐 Canvas resized: ${t}x${s}`)),this.ctx.save(),this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(e,0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}async fetchCertificateFingerprint(){try{const t=await(await fetch("https://50-19-36-193.nip.io/certificate.sha256")).text();return this.log(`🔒 Certificate fingerprint: ${t.trim()}`),this.hexToBytes(t.trim())}catch(e){throw console.error("❌ Failed to fetch certificate fingerprint:",e),e}}hexToBytes(e){const t=new Uint8Array(e.length/2);for(let s=0;s<e.length;s+=2)t[s/2]=parseInt(e.substr(s,2),16);return t}async connect(){try{this.updateStatus("🔗 Connecting to MOQ server...","connecting"),this.log("🔗 Starting official MOQ connection...");const e=await this.fetchCertificateFingerprint(),t=new URL("https://50-19-36-193.nip.io:4433/"),s={webtransport:{enabled:!0,congestionControl:"low-latency",serverCertificateHashes:[{algorithm:"sha-256",value:e}]},websocket:{enabled:!1}};if(console.log("🔧 VERSION 3.10 Connection parameters:",{url:t.toString(),props:s}),this.connection=await un(t,s),console.log("🔧 Connection result:",this.connection),!this.connection)throw new Error("Connection is null after Moq.Connection.connect");this.log("✅ Official MOQ connection established"),this.connection.closed.then(()=>{this.log("❌ MOQ connection closed"),this.updateStatus("Disconnected","disconnected"),this.resetUI()}),this.log("📡 Consuming MOQ broadcast from empty path..."),this.broadcast=this.connection.consume(""),this.log("✅ MOQ broadcast consumed"),this.log("📺 Subscribing to video track..."),this.videoTrack=this.broadcast.subscribe("video",1),this.log("✅ Subscribed to video track"),this.updateStatus("✅ Connected to MOQ server","connected"),this.stats.startTime=Date.now(),this.startStatsTracking(),this.handleMOQVideoTrack()}catch(e){console.error("❌ Detailed MOQ connection error:",e),e.errors&&(console.error("❌ Individual errors:",e.errors),e.errors.forEach((t,s)=>{console.error(`❌ Error ${s+1}:`,t)})),console.error("❌ MOQ connection failed:",e),this.log(`❌ MOQ connection failed: ${e.message}`),this.updateStatus("❌ Connection failed","disconnected"),this.resetUI()}}async handleMOQVideoTrack(){try{if(this.log("🎬 Processing MOQ video track..."),!this.videoTrack)throw new Error("Video track is null");for(;;)try{const e=await this.videoTrack.readFrame();if(!e){this.log("📭 No more frames from MOQ track");break}if(this.log(`📦 Received MOQ frame: ${e.length} bytes`),e.length<=50){const t=Array.from(e.slice(0,Math.min(e.length,32))).map(s=>s.toString(16).padStart(2,"0")).join(" ");this.log(`🔍 Small frame (${e.length}b): ${t}`)}this.stats.framesReceived++,this.stats.bytesReceived+=e.length,this.decodeH264Frame(e)}catch(e){if(e.name==="AbortError"){this.log("🔌 MOQ track connection closed");break}console.error("❌ Error reading MOQ frame:",e),this.log(`❌ Frame read error: ${e.message}`),await new Promise(t=>setTimeout(t,100))}}catch(e){console.error("❌ MOQ track error:",e),this.log(`❌ Track error: ${e.message}`)}}decodeH264Frame(e){try{const{data:t,timestamp:s}=this.parseHangFrame(e),r=Array.from(t.slice(0,16)).map(u=>u.toString(16).padStart(2,"0")).join(" ");if(this.avcConfig||this.log("⏳ Waiting for real avcC configuration from macOS stream (no hardcoded fallback)..."),this.isAvcConfig(t)){if(this.log(`🔧 Server sent avcC config: ${t.length} bytes, hex: ${r}`),t[0]===66){const u=new Uint8Array(t.length+1);u[0]=1,u.set(t,1),this.avcConfig=u,this.log(`🔧 Restored avcC with version prefix: ${u.length} bytes`)}else this.avcConfig=t;this.log("✅ Real avcC configuration received from macOS stream!");return}t.length>20&&this.log(`🔍 Frame analysis: length=${t.length}, first 20 bytes: ${Array.from(t.slice(0,20)).map(u=>u.toString(16).padStart(2,"0")).join(" ")}`);const a=this.isH264Keyframe(t);if(this.log(`🎬 Frame: ${t.length} bytes, keyframe: ${a}, timestamp: ${s}, hex: ${r}`),!this.decoder||this.decoder.state!=="configured"){if(!a){this.log("⚠️ Waiting for keyframe to configure decoder...");return}if(!this.avcConfig){this.log("⚠️ Waiting for avcC configuration...");return}this.configureDecoderWithConfig()}if(this.log(`🔍 About to decode: ${a?"KEYFRAME":"delta"} frame, ${t.length} bytes`),t.length>=4){const u=Array.from(t.slice(0,8)).map(f=>f.toString(16).padStart(2,"0")).join(" ");this.log(`🔍 NAL header: ${u}`);for(let f=0;f<Math.min(t.length-4,100);f++)if(t[f]===0&&t[f+1]===0&&t[f+2]===0&&t[f+3]===1){const p=t[f+4]&31,g=t[f+4]>>5&3;this.log(`🔍 Found NAL at offset ${f}: type=${p}, ref_idc=${g}`);const k={1:"Non-IDR slice",2:"Data partition A",3:"Data partition B",4:"Data partition C",5:"IDR slice",6:"SEI",7:"SPS",8:"PPS",9:"Access unit delimiter"};this.log(`🔍 NAL type ${p}: ${k[p]||"Unknown"}`)}}const c=new EncodedVideoChunk({type:a?"key":"delta",timestamp:s,data:t});if(this.decoder&&this.decoder.state==="configured")try{this.log(`🔍 Decoder state before decode: ${this.decoder.state}`),this.decoder.decode(c),this.log(`🔍 Decoder state after decode: ${this.decoder.state}`)}catch(u){console.error("❌ Decode call failed:",u),this.log(`❌ Decode call error: ${u.message}`);const f=Array.from(t.slice(0,32)).map(p=>p.toString(16).padStart(2,"0")).join(" ");this.log(`❌ Problematic frame data (first 32 bytes): ${f}`)}else this.log(`⚠️ Decoder not ready: state=${this.decoder?.state||"null"}`)}catch(t){console.error("❌ Error decoding H.264 frame:",t),this.log(`❌ Frame decoding error: ${t.message}`)}}parseHangFrame(e){const[t,s]=this.getVarInt53(e);return{timestamp:t,data:s}}getVarInt53(e){const t=1<<((e[0]&192)>>6),s=new DataView(e.buffer,e.byteOffset,t),r=new Uint8Array(e.buffer,e.byteOffset+t,e.byteLength-t);let a;if(t===1)a=e[0]&63;else if(t===2)a=s.getUint16(0)&16383;else if(t===4)a=s.getUint32(0)&1073741823;else if(t===8)a=Number(s.getBigUint64(0)&0x3fffffffffffffffn);else throw new Error("impossible");return[a,r]}isH264Keyframe(e){let t=0;for(;t<e.length-4;){if(e[t]===0&&e[t+1]===0&&e[t+2]===1){const s=e[t+3]&31;if(s===7||s===8||s===5)return!0;t+=3;continue}if(e[t]===0&&e[t+1]===0&&e[t+2]===0&&e[t+3]===1){const s=e[t+4]&31;if(s===7||s===8||s===5)return!0;t+=4;continue}if(t+4<e.length){const s=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];if(s>0&&s<e.length-t-4){const r=e[t+4]&31;if(r===7||r===8||r===5)return!0;t+=4+s;continue}}t++}return!1}isAvcConfig(e){if(e.length>=6&&e[0]===1&&e[4]===255&&e[5]===225||e.length>=5&&e[0]===66&&e[3]===255&&e[4]===225)return!0;let t=!1,s=!1;for(let r=0;r<e.length-4;r++)if(e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1){const a=e[r+4]&31;a===7&&(t=!0),a===8&&(s=!0)}return t&&s}configureDecoder(){if(this.decoder)try{const e={codec:"avc1.64001f",codedWidth:1670,codedHeight:1080,optimizeForLatency:!0};this.decoder.configure(e),this.log("✅ H.264 decoder configured (basic)")}catch(e){console.error("❌ Decoder configuration error:",e),this.log(`❌ Decoder config error: ${e.message}`)}}configureDecoderWithConfig(){if(!(!this.decoder||!this.avcConfig))try{const e={codec:"avc1.64001f",codedWidth:1670,codedHeight:1080,optimizeForLatency:!0,description:this.avcConfig};this.decoder.configure(e),this.log("✅ H.264 decoder configured with avcC description")}catch(e){console.error("❌ Decoder configuration error:",e),this.log(`❌ Decoder config error: ${e.message}`)}}updateStatus(e,t){const s=document.getElementById("status");s&&(s.textContent=e,s.className=t)}log(e){console.log(e);const t=document.getElementById("log");t&&(t.textContent+=e+`
`,t.scrollTop=t.scrollHeight)}resetUI(){this.statsInterval&&(clearInterval(this.statsInterval),this.statsInterval=null)}startStatsTracking(){this.statsInterval=setInterval(()=>{const e=(Date.now()-this.stats.startTime)/1e3;this.stats.fps=this.stats.framesReceived/e,this.log(`📊 Stats: ${this.stats.framesReceived} frames, ${this.stats.fps.toFixed(1)} fps, ${(this.stats.bytesReceived/1024/1024).toFixed(2)} MB`)},5e3)}}document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("view"),e=document.getElementById("connect");if(!n){console.error('❌ Canvas element with id="view" not found');return}if(!e){console.error('❌ Connect button with id="connect" not found');return}const t=new wn(n);e.addEventListener("click",async()=>{await t.connect()})});
